-- WARNING: This schema is for context only and is not meant to be run.
-- Table order and constraints may not be valid for execution.

CREATE TABLE public.categories (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  name character varying NOT NULL,
  description text,
  color character varying DEFAULT '#3b82f6'::character varying,
  icon character varying DEFAULT 'cube-outline'::character varying,
  store_id character varying NOT NULL,
  is_active boolean DEFAULT true,
  created_by uuid,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT categories_pkey PRIMARY KEY (id),
  CONSTRAINT fk_categories_store FOREIGN KEY (store_id) REFERENCES public.stores(id),
  CONSTRAINT fk_categories_created_by FOREIGN KEY (created_by) REFERENCES public.users(id)
);
CREATE TABLE public.companies (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  name character varying NOT NULL UNIQUE,
  description text,
  logo_url text,
  website character varying,
  contact_email character varying,
  contact_phone character varying,
  address text,
  tax_id character varying,
  settings jsonb DEFAULT '{}'::jsonb,
  is_active boolean DEFAULT true,
  created_by uuid,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  email character varying UNIQUE,
  phone character varying,
  CONSTRAINT companies_pkey PRIMARY KEY (id),
  CONSTRAINT fk_companies_created_by FOREIGN KEY (created_by) REFERENCES public.users(id)
);
CREATE TABLE public.file_uploads (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  filename text NOT NULL,
  original_name text NOT NULL,
  mime_type text NOT NULL,
  file_size integer NOT NULL,
  public_url text NOT NULL,
  upload_type text NOT NULL DEFAULT 'product_image'::text,
  uploaded_by uuid,
  company_id uuid,
  created_at timestamp with time zone DEFAULT CURRENT_TIMESTAMP,
  updated_at timestamp with time zone DEFAULT CURRENT_TIMESTAMP,
  deleted_at timestamp with time zone,
  CONSTRAINT file_uploads_pkey PRIMARY KEY (id),
  CONSTRAINT file_uploads_uploaded_by_fkey FOREIGN KEY (uploaded_by) REFERENCES public.users(id),
  CONSTRAINT file_uploads_company_id_fkey FOREIGN KEY (company_id) REFERENCES public.companies(id)
);
CREATE TABLE public.inventory_movements (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  product_id uuid NOT NULL,
  store_id character varying NOT NULL,
  movement_type character varying NOT NULL CHECK (movement_type::text = ANY (ARRAY['in'::character varying, 'out'::character varying, 'adjustment'::character varying, 'transfer'::character varying]::text[])),
  quantity integer NOT NULL,
  previous_stock integer NOT NULL DEFAULT 0,
  new_stock integer NOT NULL DEFAULT 0,
  unit_cost numeric,
  total_cost numeric,
  reference_type character varying,
  reference_id uuid,
  notes text,
  created_by uuid,
  created_at timestamp with time zone DEFAULT now(),
  CONSTRAINT inventory_movements_pkey PRIMARY KEY (id),
  CONSTRAINT fk_inventory_product FOREIGN KEY (product_id) REFERENCES public.products(id),
  CONSTRAINT fk_inventory_store FOREIGN KEY (store_id) REFERENCES public.stores(id),
  CONSTRAINT fk_inventory_created_by FOREIGN KEY (created_by) REFERENCES public.users(id)
);
CREATE TABLE public.payment_history (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  subscription_id uuid NOT NULL,
  company_id uuid NOT NULL,
  amount numeric NOT NULL,
  currency character varying DEFAULT 'USD'::character varying,
  status character varying NOT NULL CHECK (status::text = ANY (ARRAY['pending'::character varying::text, 'completed'::character varying::text, 'failed'::character varying::text, 'refunded'::character varying::text])),
  payment_method character varying,
  transaction_id character varying,
  stripe_payment_intent_id character varying,
  invoice_url text,
  receipt_url text,
  description text,
  paid_at timestamp with time zone,
  created_at timestamp with time zone DEFAULT now(),
  CONSTRAINT payment_history_pkey PRIMARY KEY (id),
  CONSTRAINT payment_history_subscription_id_fkey FOREIGN KEY (subscription_id) REFERENCES public.subscriptions(id),
  CONSTRAINT payment_history_company_id_fkey FOREIGN KEY (company_id) REFERENCES public.companies(id)
);
CREATE TABLE public.products (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  name character varying NOT NULL,
  description text,
  sku character varying UNIQUE,
  barcode character varying,
  category_id uuid,
  store_id character varying NOT NULL,
  default_price numeric NOT NULL DEFAULT 0.00,
  manila_price numeric,
  delivery_price numeric,
  wholesale_price numeric,
  stock_quantity integer DEFAULT 0,
  min_stock_level integer DEFAULT 5,
  max_stock_level integer DEFAULT 100,
  unit character varying DEFAULT 'pcs'::character varying,
  weight numeric,
  dimensions jsonb,
  image_url text,
  images jsonb,
  is_active boolean DEFAULT true,
  is_featured boolean DEFAULT false,
  tags jsonb,
  created_by uuid,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT products_pkey PRIMARY KEY (id),
  CONSTRAINT fk_products_category FOREIGN KEY (category_id) REFERENCES public.categories(id),
  CONSTRAINT fk_products_store FOREIGN KEY (store_id) REFERENCES public.stores(id),
  CONSTRAINT fk_products_created_by FOREIGN KEY (created_by) REFERENCES public.users(id)
);
CREATE TABLE public.sales (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  company_id uuid,
  store_id character varying,
  staff_id uuid,
  total_amount numeric NOT NULL,
  items_count integer DEFAULT 1,
  notes text,
  created_at timestamp with time zone DEFAULT now(),
  created_by uuid,
  payment_method character varying DEFAULT 'cash'::character varying,
  subtotal numeric DEFAULT 0,
  discount_amount numeric DEFAULT 0,
  discount_type character varying,
  tax_amount numeric DEFAULT 0,
  customer_name character varying,
  customer_phone character varying,
  receipt_number character varying UNIQUE,
  CONSTRAINT sales_pkey PRIMARY KEY (id),
  CONSTRAINT sales_company_id_fkey FOREIGN KEY (company_id) REFERENCES public.companies(id),
  CONSTRAINT sales_store_id_fkey FOREIGN KEY (store_id) REFERENCES public.stores(id),
  CONSTRAINT sales_staff_id_fkey FOREIGN KEY (staff_id) REFERENCES public.staff(id),
  CONSTRAINT sales_created_by_fkey FOREIGN KEY (created_by) REFERENCES public.users(id)
);
CREATE TABLE public.sales_items (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  sales_id uuid,
  product_id uuid,
  quantity integer NOT NULL DEFAULT 1,
  unit_price numeric NOT NULL,
  total_price numeric NOT NULL,
  created_at timestamp with time zone DEFAULT now(),
  discount_amount numeric DEFAULT 0,
  discount_percent numeric DEFAULT 0,
  barcode character varying,
  CONSTRAINT sales_items_pkey PRIMARY KEY (id),
  CONSTRAINT sales_items_sales_id_fkey FOREIGN KEY (sales_id) REFERENCES public.sales(id),
  CONSTRAINT sales_items_product_id_fkey FOREIGN KEY (product_id) REFERENCES public.products(id)
);
CREATE TABLE public.staff (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  staff_id character varying NOT NULL UNIQUE,
  name character varying NOT NULL,
  store_id character varying NOT NULL,
  passcode character varying NOT NULL,
  role character varying NOT NULL DEFAULT 'staff'::character varying CHECK (role::text = ANY (ARRAY['staff'::character varying, 'supervisor'::character varying]::text[])),
  hourly_rate numeric DEFAULT 15.00,
  image_url text,
  is_active boolean DEFAULT true,
  created_by uuid,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  company_id uuid,
  CONSTRAINT staff_pkey PRIMARY KEY (id),
  CONSTRAINT fk_staff_store FOREIGN KEY (store_id) REFERENCES public.stores(id),
  CONSTRAINT fk_staff_created_by FOREIGN KEY (created_by) REFERENCES public.users(id),
  CONSTRAINT staff_company_id_fkey FOREIGN KEY (company_id) REFERENCES public.companies(id)
);
CREATE TABLE public.staff_activity_logs (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  staff_id uuid NOT NULL,
  company_id uuid NOT NULL,
  store_id character varying NOT NULL,
  action_type character varying NOT NULL,
  action_details jsonb DEFAULT '{}'::jsonb,
  ip_address character varying,
  user_agent text,
  created_at timestamp with time zone DEFAULT now(),
  CONSTRAINT staff_activity_logs_pkey PRIMARY KEY (id),
  CONSTRAINT staff_activity_logs_staff_id_fkey FOREIGN KEY (staff_id) REFERENCES public.staff(id),
  CONSTRAINT staff_activity_logs_company_id_fkey FOREIGN KEY (company_id) REFERENCES public.companies(id)
);
CREATE TABLE public.stores (
  id character varying NOT NULL,
  name character varying NOT NULL,
  address text,
  phone character varying,
  is_active boolean DEFAULT true,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  company_id uuid,
  company_name character varying DEFAULT 'Default Company'::character varying,
  status character varying DEFAULT 'pending'::character varying CHECK (status::text = ANY (ARRAY['pending'::character varying, 'active'::character varying, 'suspended'::character varying, 'cancelled'::character varying]::text[])),
  created_by uuid,
  settings jsonb DEFAULT '{}'::jsonb,
  CONSTRAINT stores_pkey PRIMARY KEY (id),
  CONSTRAINT stores_created_by_fkey FOREIGN KEY (created_by) REFERENCES public.users(id),
  CONSTRAINT fk_stores_company FOREIGN KEY (company_id) REFERENCES public.companies(id)
);
CREATE TABLE public.subscription_usage (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  subscription_id uuid NOT NULL,
  company_id uuid NOT NULL,
  period_start timestamp with time zone NOT NULL,
  period_end timestamp with time zone NOT NULL,
  users_count integer DEFAULT 0,
  stores_count integer DEFAULT 0,
  products_count integer DEFAULT 0,
  sales_count integer DEFAULT 0,
  storage_used_mb numeric DEFAULT 0,
  api_calls_count integer DEFAULT 0,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT subscription_usage_pkey PRIMARY KEY (id),
  CONSTRAINT subscription_usage_subscription_id_fkey FOREIGN KEY (subscription_id) REFERENCES public.subscriptions(id),
  CONSTRAINT subscription_usage_company_id_fkey FOREIGN KEY (company_id) REFERENCES public.companies(id)
);
CREATE TABLE public.subscriptions (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  company_id uuid NOT NULL,
  plan_name character varying NOT NULL DEFAULT 'trial'::character varying,
  plan_type character varying NOT NULL DEFAULT 'monthly'::character varying CHECK (plan_type::text = ANY (ARRAY['monthly'::character varying::text, 'yearly'::character varying::text, 'lifetime'::character varying::text])),
  status character varying NOT NULL DEFAULT 'active'::character varying CHECK (status::text = ANY (ARRAY['active'::character varying::text, 'cancelled'::character varying::text, 'suspended'::character varying::text, 'expired'::character varying::text, 'pending'::character varying::text])),
  price_amount numeric DEFAULT 0,
  currency character varying DEFAULT 'USD'::character varying,
  max_users integer DEFAULT 5,
  max_stores integer DEFAULT 1,
  max_products integer DEFAULT 100,
  features jsonb DEFAULT '{"pos": true, "reports": false, "inventory": true, "multi_store": false}'::jsonb,
  trial_ends_at timestamp with time zone,
  current_period_start timestamp with time zone DEFAULT now(),
  current_period_end timestamp with time zone DEFAULT (now() + '1 mon'::interval),
  next_billing_date timestamp with time zone,
  payment_method character varying,
  stripe_subscription_id character varying,
  stripe_customer_id character varying,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT subscriptions_pkey PRIMARY KEY (id),
  CONSTRAINT subscriptions_company_id_fkey FOREIGN KEY (company_id) REFERENCES public.companies(id)
);
CREATE TABLE public.super_admins (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  email character varying NOT NULL UNIQUE,
  password text NOT NULL,
  name character varying NOT NULL,
  phone character varying,
  avatar_url text,
  permissions jsonb DEFAULT '{"view_analytics": true, "system_settings": true, "manage_companies": true, "manage_subscriptions": true}'::jsonb,
  is_active boolean DEFAULT true,
  last_login timestamp with time zone,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT super_admins_pkey PRIMARY KEY (id)
);
CREATE TABLE public.users (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  email character varying NOT NULL UNIQUE,
  password text NOT NULL,
  name character varying NOT NULL,
  role character varying NOT NULL DEFAULT 'staff'::character varying CHECK (role::text = ANY (ARRAY['manager'::character varying::text, 'supervisor'::character varying::text, 'staff'::character varying::text])),
  phone character varying,
  store_id character varying,
  is_active boolean DEFAULT true,
  last_login timestamp with time zone,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  company_id uuid,
  CONSTRAINT users_pkey PRIMARY KEY (id),
  CONSTRAINT fk_users_company FOREIGN KEY (company_id) REFERENCES public.companies(id)
);